{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ district.name }} - MGNREGA Performance{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="{% url 'district_list' %}" class="btn btn-outline-primary mb-3">
                <i class="bi bi-arrow-left"></i> Back to Districts / वापस जाएं
            </a>
            <h1 class="display-4 fw-bold">
                <i class="bi bi-geo-alt-fill text-primary"></i>
                {{ district.name }}, {{ district.state }}
            </h1>
            <p class="lead">MGNREGA Performance Dashboard / मनरेगा प्रदर्शन डैशबोर्ड</p>
        </div>
    </div>

    <!-- Data Source Info -->
    <div class="alert {% if 'Live' in data_source %}alert-success{% else %}alert-info{% endif %}">
        <i class="bi bi-{% if 'Live' in data_source %}wifi{% else %}database{% endif %}"></i> 
        <strong>Data Source:</strong> {{ data_source }}
        {% if data_records_count > 0 %}
        <br><small>{{ data_records_count }} record(s) available</small>
        {% endif %}
    </div>

    {% if latest_data %}
        <!-- Show data if it exists, regardless of values -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle-fill"></i> Latest Data Period
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-2"><strong>Year:</strong> {{ latest_data.year }}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-2"><strong>Month:</strong> 
                                    {% if latest_data.month %}
                                        {{ latest_data.month }}
                                    {% else %}
                                        Annual
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-2"><strong>Last Updated:</strong> {{ latest_data.updated_at|date:"d M Y" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if has_meaningful_data %}
        <!-- Key Metrics Cards - Only show if data is meaningful -->
        <div class="row mb-4">
            <!-- Total Workers -->
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-primary text-white h-100">
                    <div class="card-body">
                        <h6 class="text-white-50 mb-1">
                            <i class="bi bi-people-fill"></i>
                        </h6>
                        <h2 class="mb-0">{{ latest_data.total_workers|default:0|intcomma }}</h2>
                        <small>Total Workers / कुल कामगार</small>
                        <div class="mt-2">
                            <small>Active: {{ latest_data.total_active_workers|default:0|intcomma }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Person-Days -->
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-success text-white h-100">
                    <div class="card-body">
                        <h6 class="text-white-50 mb-1">
                            <i class="bi bi-calendar-check-fill"></i>
                        </h6>
                        <h2 class="mb-0">{{ latest_data.total_work_days|default:0|floatformat:0|intcomma }}</h2>
                        <small>Person-Days / व्यक्ति-दिवस</small>
                        <div class="mt-2">
                            <small>Avg: {{ latest_data.average_days_per_household|default:0|floatformat:1 }} days/HH</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Expenditure -->
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-info text-white h-100">
                    <div class="card-body">
                        <h6 class="text-white-50 mb-1">
                            <i class="bi bi-currency-rupee"></i>
                        </h6>
                        <h2 class="mb-0">₹{{ latest_data.total_expenditure|default:0|floatformat:0|intcomma }}</h2>
                        <small>Total Expenditure / कुल व्यय</small>
                        <div class="mt-2">
                            <small>Wages: ₹{{ latest_data.wage_expenditure|default:0|floatformat:0|intcomma }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employment Rate -->
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-warning text-white h-100">
                    <div class="card-body">
                        <h6 class="text-white-50 mb-1">
                            <i class="bi bi-graph-up-arrow"></i>
                        </h6>
                        <h2 class="mb-0">{{ latest_data.employment_rate|default:0|floatformat:1 }}%</h2>
                        <small>Employment Rate / रोजगार दर</small>
                        <div class="mt-2">
                            <small>Works: {{ latest_data.works_completed|default:0|intcomma }} completed</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Has records but minimal activity -->
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <h4>Limited MGNREGA Activity / सीमित मनरेगा गतिविधि</h4>
            <p>
                <strong>{{ district.name }}</strong> has {{ data_records_count }} data record(s), but shows minimal or no MGNREGA activity.
            </p>
            <p>
                This is common for urban districts where MGNREGA implementation is limited, as the program primarily focuses on rural employment.
            </p>
            <div class="mt-3">
                <p class="mb-0"><strong>Data Period:</strong> Year {{ latest_data.year }}{% if latest_data.month %}, Month {{ latest_data.month }}{% endif %}</p>
                <p class="mb-0"><strong>Last Updated:</strong> {{ latest_data.updated_at|date:"d M Y" }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Detailed Breakdown Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-table"></i> Detailed Performance Metrics / विस्तृत प्रदर्शन मेट्रिक्स
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Metric / मेट्रिक</th>
                                        <th class="text-end">Value / मूल्य</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><i class="bi bi-calendar3"></i> <strong>Year / वर्ष</strong></td>
                                        <td class="text-end">{{ latest_data.year }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-calendar-month"></i> <strong>Month / महीना</strong></td>
                                        <td class="text-end">{% if latest_data.month %}{{ latest_data.month }}{% else %}Annual{% endif %}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-people"></i> <strong>Total Workers / कुल श्रमिक</strong></td>
                                        <td class="text-end">{{ latest_data.total_workers|default:0|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-person-check"></i> <strong>Active Workers / सक्रिय श्रमिक</strong></td>
                                        <td class="text-end">{{ latest_data.total_active_workers|default:0|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-card-heading"></i> <strong>Job Cards Issued / जॉब कार्ड जारी</strong></td>
                                        <td class="text-end">{{ latest_data.total_job_cards_issued|default:0|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-calendar-check"></i> <strong>Total Work Days / कुल कार्य दिवस</strong></td>
                                        <td class="text-end">{{ latest_data.total_work_days|default:0|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-house"></i> <strong>Average Days per Household / प्रति परिवार औसत दिन</strong></td>
                                        <td class="text-end">{{ latest_data.average_days_per_household|default:0|floatformat:2 }}</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><i class="bi bi-currency-rupee"></i> <strong>Total Expenditure / कुल व्यय</strong></td>
                                        <td class="text-end"><strong>₹{{ latest_data.total_expenditure|default:0|floatformat:2|intcomma }}</strong></td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-wallet2"></i> <strong>Wage Expenditure / मजदूरी व्यय</strong></td>
                                        <td class="text-end">₹{{ latest_data.wage_expenditure|default:0|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-tools"></i> <strong>Material Expenditure / सामग्री व्यय</strong></td>
                                        <td class="text-end">₹{{ latest_data.material_expenditure|default:0|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-briefcase"></i> <strong>Works Completed / पूर्ण कार्य</strong></td>
                                        <td class="text-end">{{ latest_data.works_completed|default:0|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="bi bi-hourglass-split"></i> <strong>Works In Progress / प्रगतिरत कार्य</strong></td>
                                        <td class="text-end">{{ latest_data.works_in_progress|default:0|intcomma }}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><i class="bi bi-graph-up"></i> <strong>Employment Rate / रोजगार दर</strong></td>
                                        <td class="text-end"><strong>{{ latest_data.employment_rate|default:0|floatformat:2 }}%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Data -->
        {% if historical_data %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> Historical Data / ऐतिहासिक डेटा
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Month</th>
                                        <th class="text-end">Workers</th>
                                        <th class="text-end">Work Days</th>
                                        <th class="text-end">Expenditure (₹)</th>
                                        <th class="text-end">Employment %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in historical_data %}
                                    <tr>
                                        <td>{{ record.year }}</td>
                                        <td>{% if record.month %}{{ record.month }}{% else %}-{% endif %}</td>
                                        <td class="text-end">{{ record.total_workers|default:0|intcomma }}</td>
                                        <td class="text-end">{{ record.total_work_days|default:0|floatformat:0|intcomma }}</td>
                                        <td class="text-end">{{ record.total_expenditure|default:0|floatformat:0|intcomma }}</td>
                                        <td class="text-end">{{ record.employment_rate|default:0|floatformat:1 }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    {% else %}
    <!-- No data at all -->
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <h4>No Data Available / कोई डेटा उपलब्ध नहीं</h4>
        <p>Performance data for <strong>{{ district.name }}</strong> is not available in the database.</p>
        <p class="mb-0">
            <strong>Possible reasons:</strong>
            <ul>
                <li>District data hasn't been synced from the API yet</li>
                <li>District may not participate in MGNREGA</li>
                <li>API may not have data for this district</li>
            </ul>
        </p>
        <a href="{% url 'district_list' %}" class="btn btn-primary mt-3">
            <i class="bi bi-arrow-left"></i> Back to District List
        </a>
    </div>
    {% endif %}
</div>

<style>
.metric-card {
    border: none;
    border-radius: 10px;
}

.metric-card .card-body {
    padding: 1.5rem;
}

.metric-card h2 {
    font-weight: bold;
    font-size: 2rem;
}

.table th {
    background-color: #f8f9fa;
}
</style>
{% endblock %}