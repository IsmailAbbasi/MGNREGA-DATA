{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ district.name }} - MGNREGA Performance{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <a href="{% url 'district_list' %}" class="btn btn-outline-primary mb-3">
                <i class="bi bi-arrow-left"></i> Back to Districts / वापस जाएं
            </a>
            <h1 class="display-4 fw-bold">
                <i class="bi bi-geo-alt-fill text-primary"></i>
                {{ district.name }}, {{ district.state }}
            </h1>
            <p class="lead text-muted">
                MGNREGA Performance Dashboard / मनरेगा प्रदर्शन डैशबोर्ड
            </p>
            
            <!-- Data Source Indicator -->
            <div class="alert {% if api_status == 'connected' %}alert-success{% else %}alert-warning{% endif %} d-flex align-items-center">
                <i class="bi {% if api_status == 'connected' %}bi-wifi{% else %}bi-wifi-off{% endif %} me-2 fs-4"></i>
                <div>
                    <strong>Data Source:</strong> {{ data_source }}
                    {% if api_status == 'offline' %}
                    <br><small>Showing cached data. Government API is currently unavailable.</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if latest_data %}
    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="bi bi-people-fill"></i>
                <h3>{{ latest_data.total_workers|intcomma }}</h3>
                <p>Total Workers / कुल कामगार</p>
                <small>Active: {{ latest_data.total_active_workers|intcomma }}</small>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="bi bi-calendar-check"></i>
                <h3>{{ latest_data.total_work_days|floatformat:0|intcomma }}</h3>
                <p>Person-Days / व्यक्ति-दिवस</p>
                <small>Avg: {{ latest_data.average_days_per_household|floatformat:1 }} days/HH</small>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="bi bi-currency-rupee"></i>
                <h3>₹{{ latest_data.total_expenditure|floatformat:0|intcomma }}</h3>
                <p>Total Expenditure / कुल व्यय</p>
                <small>Wages: ₹{{ latest_data.wage_expenditure|floatformat:0|intcomma }}</small>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <i class="bi bi-graph-up-arrow"></i>
                <h3>{{ latest_data.employment_rate|floatformat:1 }}%</h3>
                <p>Employment Rate / रोजगार दर</p>
                <small>Works: {{ latest_data.works_completed|intcomma }} completed</small>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Monthly Employment Trend</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="employmentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart-fill"></i> Expenditure Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="expenditureChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Data Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Historical Performance / ऐतिहासिक प्रदर्शन</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Workers</th>
                                    <th>Work Days</th>
                                    <th>Expenditure</th>
                                    <th>Employment Rate</th>
                                    <th>Works Completed</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in historical_data %}
                                <tr>
                                    <td>{{ data.year }}-{% if data.month %}{{ data.month|stringformat:"02d" }}{% else %}Annual{% endif %}</td>
                                    <td>{{ data.total_workers|intcomma }}</td>
                                    <td>{{ data.total_work_days|floatformat:0|intcomma }}</td>
                                    <td>₹{{ data.total_expenditure|floatformat:0|intcomma }}</td>
                                    <td>{{ data.employment_rate|floatformat:1 }}%</td>
                                    <td>{{ data.works_completed|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Data Available -->
    <div class="alert alert-warning text-center">
        <i class="bi bi-exclamation-triangle-fill fs-1"></i>
        <h4 class="mt-3">No Data Available / कोई डेटा उपलब्ध नहीं</h4>
        <p>Performance data for {{ district.name }} is not available yet.</p>
        <p>Please check back later or contact the administrator.</p>
    </div>
    {% endif %}
</div>

<script>
    // Employment Trend Chart
    const employmentCtx = document.getElementById('employmentChart').getContext('2d');
    new Chart(employmentCtx, {
        type: 'line',
        data: {
            labels: [{% for data in historical_data reversed %}'{{ data.year }}-{{ data.month|default:"Annual" }}',{% endfor %}],
            datasets: [{
                label: 'Employment Rate (%)',
                data: [{% for data in historical_data reversed %}{{ data.employment_rate }},{% endfor %}],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true }
            }
        }
    });

    // Expenditure Breakdown Chart
    const expenditureCtx = document.getElementById('expenditureChart').getContext('2d');
    new Chart(expenditureCtx, {
        type: 'doughnut',
        data: {
            labels: ['Wages / मजदूरी', 'Materials / सामग्री'],
            datasets: [{
                data: [{{ latest_data.wage_expenditure }}, {{ latest_data.material_expenditure }}],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>
{% endblock %}