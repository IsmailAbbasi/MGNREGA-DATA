{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Select District - MGNREGA{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">
            <i class="bi bi-geo-alt-fill"></i> 
            अपना ज़िला चुनें
        </h1>
        <p class="lead text-muted">Select Your District / Choose your district to view MGNREGA performance</p>
    </div>
    
    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="input-group input-group-lg">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="searchDistrict" placeholder="Search district / ज़िला खोजें... (e.g., Lucknow, Mumbai, Pune)">
            </div>
            <div id="searchResults" class="mt-2 text-muted"></div>
        </div>
    </div>
    
    <!-- Districts Grid -->
    <div class="row" id="districtGrid">
        {% for district in districts %}
        <div class="col-md-4 col-sm-6 mb-4 district-item" 
             data-name="{{ district.name|lower }}" 
             data-state="{{ district.state|lower }}"
             data-code="{{ district.district_code|lower }}">
            <div class="card district-card">
                <div class="card-header">
                    <i class="bi bi-pin-map-fill"></i> {{ district.name }}
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <i class="bi bi-building"></i> 
                        <strong>State:</strong> {{ district.state }}
                    </p>
                    <p class="mb-3">
                        <i class="bi bi-people-fill"></i> 
                        <strong>Population:</strong> {{ district.population|intcomma|default:"N/A" }}
                    </p>
                    <a href="{% url 'district_detail' district.id %}" class="btn btn-primary-custom w-100">
                        <i class="bi bi-bar-chart-fill"></i> View Performance / प्रदर्शन देखें
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <h4>No districts available</h4>
                <p>Please add districts through the admin panel.</p>
                <a href="/admin/" class="btn btn-primary-custom mt-3">Go to Admin Panel</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Search functionality with debouncing
    let searchTimeout;
    const searchInput = document.getElementById('searchDistrict');
    const districtItems = document.querySelectorAll('.district-item');
    const searchResults = document.getElementById('searchResults');
    
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
            const searchTerm = e.target.value.toLowerCase().trim();
            let visibleCount = 0;
            
            districtItems.forEach(district => {
                const name = district.getAttribute('data-name');
                const state = district.getAttribute('data-state');
                const code = district.getAttribute('data-code');
                
                // Search in name, state, or code
                const matches = name.includes(searchTerm) || 
                               state.includes(searchTerm) || 
                               code.includes(searchTerm);
                
                if (searchTerm === '' || matches) {
                    district.style.display = 'block';
                    visibleCount++;
                } else {
                    district.style.display = 'none';
                }
            });
            
            // Update search results message
            if (searchTerm === '') {
                searchResults.textContent = '';
            } else if (visibleCount === 0) {
                searchResults.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> No districts found matching "' + e.target.value + '"</span>';
            } else {
                searchResults.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Found ' + visibleCount + ' district(s)</span>';
            }
        }, 300); // Wait 300ms after user stops typing
    });
    
    // Clear search on Escape key
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            this.dispatchEvent(new Event('input'));
        }
    });
</script>
{% endblock %}